{% extends "admin/login.html" %}
{% load i18n %}

{% block content %}

{% block extrastyle %}
{{ block.super }}
<style nonce="{{ request.csp_nonce }}">
  .captcha-row {
    display: flex;
    flex-direction: row-reverse;
  }
  .captcha {
    border-radius: 5px;
  }
  #id_captcha_1 {
    flex-grow: 2;
    margin-right: 4px;
    height: 25px;
  }
</style>
{% endblock %}


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.0.0-rc.1/jsencrypt.min.js" nonce="{{ request.csp_nonce }}"></script>

<form id="custom-login-form" method="post" action="{% url 'custom_admin_login' %}">

  {% csrf_token %}
  <div class="form-row">
    {{ form.username.errors }}
    {{ form.username.label_tag }} {{ form.username }}
  </div>
  <div class="form-row">
    {{ form.password.errors }}

    <input type="password" name="password" autocomplete="OFF" required="" id="id_password">
    <input type="hidden" name="next" value="{{ next }}">
  </div>
  <div class="form-row captcha-row">
    {{ form.captcha }}
  </div>
  {{ form.captcha.errors }}
  {% url 'admin_password_reset' as password_reset_url %}
  {% if password_reset_url %}
  <div class="password-reset-link">
    <a href="{{ password_reset_url }}">{% translate 'Forgotten your password or username?' %}</a>
  </div>
  {% endif %}
  <div class="submit-row">
    <input type="submit" value="{% translate 'Log in' %}">
  </div>
</form>
<script nonce="{{CSP_NONCE}}">
function getCookie(cookieName) {
    const name = cookieName + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const cookieArray = decodedCookie.split(';');
    for (let i = 0; i < cookieArray.length; i++) {
        let cookie = cookieArray[i].trim();
        if (cookie.indexOf(name) === 0) {
            return cookie.substring(name.length, cookie.length).replace(/^"(.*)"$/, '$1');
        }
    }
    return null;
}

document.addEventListener('DOMContentLoaded', function() {
    var loginForm = document.getElementById('custom-login-form');
    if (!loginForm) return;
    loginForm.addEventListener('submit', function(event) {
        var passwordField = document.getElementById('id_password');
        if (!passwordField) {
            alert("Password field not found. Please refresh the page.");
            event.preventDefault();
            return;
        }
        var base64PublicKey = getCookie('rsa_public_key');
        if (!base64PublicKey) {
            alert("Encryption key missing. Please refresh the page.");
            event.preventDefault();
            return;
        }
        try {
            var publicKey = atob(base64PublicKey);
            var encrypt = new JSEncrypt();
            encrypt.setPublicKey(publicKey);
            var encryptedPassword = encrypt.encrypt(passwordField.value);
            if (!encryptedPassword) {
                alert("Encryption failed. Please try again.");
                event.preventDefault();
                return;
            }
            passwordField.value = encryptedPassword;
        } catch (e) {
            alert("Encryption error: " + e);
            event.preventDefault();
            return;
        }
    });
});

// Disable copy-paste and keyboard shortcuts
window.onload = function() {
    var passwordField = document.getElementById("id_password");
    if (!passwordField) return;
    passwordField.addEventListener("copy", function(event) {
        event.preventDefault();
        return false;
    });
    passwordField.addEventListener("paste", function(event) {
        event.preventDefault();
        return false;
    });
    passwordField.addEventListener("cut", function(event) {
        event.preventDefault();
        return false;
    });
    passwordField.addEventListener("keydown", function(event) {
        if (event.ctrlKey || event.metaKey) {
            event.preventDefault();
            return false;
        }
    });
};
</script>
{% endblock %}